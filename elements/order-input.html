<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<dom-module id="order-input">
    <template>
        <style>
            .hidden {
                display: none;
            }
            paper-input {
                /* display: inline-block; */
                max-width: 100px;
                --paper-input-container: { 
                    padding: 0;
                };
            }
            paper-checkbox {
                margin-left: 10px;
            }
            paper-button {
                margin-top: 10px;
            }
            #tipContainer {
                display: flex;
                align-items: flex-end;
            }
            span[slot="prefix"] {
                padding-right: 2px;
            }
            div[contenteditable] {
                border: 5px solid black;
                overflow-x: scroll;
                overflow-y: scroll;
                height: 500px;
            }
        </style>
        <div>
            <div id="input" contenteditable="true" on-input="_test" autofocus></div>
            <textarea id="textarea" rows="20" cols="60" placeholder="Paste order details here"></textarea>
            <paper-input type="number" label="Taxes" id="tax">
                <span slot="prefix">$</span>
            </paper-input>
            <paper-input type="number" label="Fees"  id="fee">
                <span slot="prefix">$</span>
            </paper-input>
            <div id="tipContainer">
            <paper-input type="number" label="Tip"   id="tip">
                <span slot="prefix" class$="[[_computeTipDollarClass(usePercentForTip)]]">$</span>
                <span slot="suffix" class$="[[_computeTipPercentClass(usePercentForTip)]]">%</span>
            </paper-input>
            <paper-checkbox checked="{{usePercentForTip}}" on-tap="_onCheckboxTap">Percentage</paper-checkbox>
            </div>
            <paper-button id="split" on-tap="_onSplitButtonTap">Split</paper-button>
        </div>
        <iron-location id="location"></iron-location>
    </template>
    <script>
        (function() {
            const parsers = require('../common/parsers.js');
            window.Order = require('../common/order.js');;
            defineCustomElement('order-input', class extends Polymer.Element {
                _test() {

                    // var highlight = element => element.style.backgroundColor = 'yellow';
                    var highlight = element => {
                        element.style.background = 'repeating-linear-gradient(45deg, yellow, yellow 10px, #fafa0a 10px, #fafa0a 20px )';
                        element.title = 'OrderSplitter is using this value';
                    }

                    var summaryTable = Array.from(this.$.input.querySelectorAll('#order-confirmation-page tr'));
                    if (summaryTable) {
                        summaryTable.map(tr => Array.from(tr.querySelectorAll('td'))).filter(tds => tds.length).forEach(([left_td, center_td, right_td]) => {
                            let label, price;

                            if (right_td && right_td.classList.contains('price-table')) {
                                price = right_td.innerText;
                                highlight(right_td);
                                console.log('price', price);
                            }

                            if (center_td && (label = center_td.querySelector('li strong'))) {
                                highlight(label);
                                label = label.innerText;
                                console.log('label', label);
                            }
                        });
                    }

                    var infoTable = Array.from(this.$.input.querySelectorAll('div.order-information tr'));
                    console.log('infoTable', infoTable);
                    if (infoTable) {
                        infoTable.map(tr => Array.from(tr.querySelectorAll('td'))).filter(tds => tds.length).forEach(([left, right]) => {
                            [
                                'Sales Tax',
                                'Processing Fee',
                                'Delivery Fee',
                                'Tip'
                            ].forEach(chargeLabel => {
                                if (left.textContent === chargeLabel) {
                                    console.log(chargeLabel, right.textContent);
                                    highlight(right);
                                }
                            });
                        });
                    }
                }
                ready() {
                    super.ready();
                    this.usePercentForTip = JSON.parse(localStorage.getItem('usePercentForTip'));
                }
                _computeTipPercentClass() {
                    return this.usePercentForTip ? '' : 'hidden';
                }
                _computeTipDollarClass() {
                    return !this.usePercentForTip ? '' : 'hidden';
                }
                _onSplitButtonTap() {
                    var text = this.$.textarea.value;
                    var tax = Number(this.$.tax.value || 0);
                    var fee = Number(this.$.fee.value || 0);
                    var tip = Number(this.$.tip.value || 0);
                    var isTipPercentage = this.usePercentForTip;

                    var order;
                    try {
                        order =  new parsers.OrderUpParser().parse(text, fee, tax, tip, isTipPercentage).split();
                    } catch(e) {
                        console.error('OrderUp parser failed', e);
                        console.log('trying csv parser');
                        order =  new parsers.CsvParser().parse(text).split();
                    }
                    this._changeUrl(order);
                }
                _changeUrl(order) {
                    let query = 'tax=' + order.tax + '&fee=' + order.fee + '&tip=' + order.tipDollars;

                    for (var [person, val] of order.people) {
                        query += '&' + encodeURIComponent(person) + '=' + Utils._prettifyNumber(val);
                    }
                    this.$.location.query = query;
                }
                _onCheckboxTap() {
                    localStorage.setItem('usePercentForTip', JSON.stringify(!this.usePercentForTip));
                }
            });
        })();
    </script>
</dom-module>
