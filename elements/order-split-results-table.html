<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">

<dom-module id="order-split-results-table">
    <template hidden>
        <style>
            :host {
                @apply(--paper-font-common-base);
            }
            span.chip {
                @apply(--paper-font-common-base);
                /* background-color: var(--paper-grey-300); */
                padding: 5px;
                border-radius: 14px;
                line-height: 38px;
            }
            td {
                white-space: nowrap; /* maintain dignity on small-width windows */
            }
            div#main {
                padding: 20px;
                margin: 20px;
                background: white;
            }
            .totals-row .chip {
                font-weight: bold;
            }
            .totals-row > td:first-child {
                font-weight: bold;
            }
        </style>
        <div id="main">
            <table>
                <template is="dom-repeat" items="[[_computeBreakdownItems(order.people)]]">
                    <tr>
                        <td>[[item.name]]</td>
                        <td>
                            <span class="chip">$[[item.price]] price</span>
                        </td>
                        <td>
                            +
                            <span class="chip">$[[_multiply(item.price, order.taxPercent)]] tax <paper-tooltip>[[item.price]] x [[order.taxPercent]]</paper-tooltip></span>
                        </td>
                        <td>
                            +
                            <span class="chip">$[[_computeFeesPerPerson(order, item.name)]] fee <paper-tooltip>[[_computeFeesPerPersonTooltip(order, item.name)]]</paper-tooltip></span>
                        </td>
                        <td>
                            +
                            <span class="chip">$[[_multiply(item.price, order.tipPercent)]] tip <paper-tooltip>[[item.price]] x [[order.tipPercent]]</paper-tooltip></span>
                        </td>
                        <td>
                            =
                            <span class="chip">$[[_computePersonTotal(item.name)]]</span>
                        </td>
                    </tr>
                </template>
                <tr class="totals-row">
                    <td>Everyone</td>
                    <td>
                        <span class="chip">$[[_prettifyNumber(order.subTotal)]] subtotal<paper-tooltip>sum of item costs</paper-tooltip></span>
                    </td>
                    <td>
                        +
                        <span class="chip">$[[_prettifyNumber(order.tax)]] tax</span>
                    </td>
                    <td>
                        +
                        <span class="chip">$[[_prettifyNumber(order.fee)]] fee</span>
                    </td>
                    <td>
                        +
                        <span class="chip">$[[_prettifyNumber(order.tipDollars)]] tip</span>
                    </td>
                    <td>
                        =
                        <span class="chip">$[[_prettifyNumber(order.total)]] total<paper-tooltip>subtotal + tax + fees + tip</paper-tooltip></span>
                    </td>
                </tr>
            </table>
            <paper-button on-tap="_onClipboardTap" raised>Copy to Clipboard</paper-button>
            <textarea id="textForClipboard" value="[[_makeTextForClipboard(order.totals)]]" hidden></textarea>

            <iron-location 
                on-query-changed="_handleQueryStringChanged">
            </iron-location>
        </div>
    </template>
    <script>
        (function() {
            const parsers = require('../common/parsers.js');
            const Order = require('../common/order.js');
            const QueryStringParserLocal = parsers.QueryStringParser;
            defineCustomElement('order-split-results-table', class extends Polymer.Element {
                _onClipboardTap() {
                    this.$.textForClipboard.hidden = false;
                    this.$.textForClipboard.select();
                    var successful = document.execCommand('copy');
                    if (!successful) {
                        console.error('clipboard copy failed');
                    } else {
                        this.$.textForClipboard.hidden = true;
                    }
                }
                _computeBreakdownItems(people) {
                    if (!people) {
                        return [];
                    }
                    return Array.from(this.order.people.entries()).map(([name, price]) => ({ name, price }));
                }
                _computeFeesPerPerson(order, name) {
                    return this._prettifyNumber(order.feesPerPerson[name]);
                }
                _computeFeesPerPersonTooltip(order, name) {
                    return `${order.untaxedFees} x ${order.people.get(name)} / ${order.subTotal}`;
                }
                _computePersonTotal(name) {
                    return this._prettifyNumber(this.order.totals.get(name));
                }
                _multiply(a, b) {
                    return this._prettifyNumber(a * b);
                }
                constructor() {
                    super();
                    this.hidden = true;
                }

                static get properties() {
                    return {
                        order: {
                            type: Object,
                            observer: '_onOrderChanged'
                        }
                    };
                }
                _onOrderChanged(order) {
                    console.log(order);
                    if (order && order.constructor !== Order) {
                        throw new Error('order must be of type Order');
                    }
                    this.hidden = !order;
                }
                /**
                 * Returns a string of a number in the format "#.##"
                 * @example
                 * _prettifyNumber(12); // returns "12.00"
                 * @param {number} n - The number to prettify
                 * @returns {string} A string of a number rounded and padded to 2 decimal places
                 */
                _prettifyNumber(n) {
                    return Utils._prettifyNumber(n);
                }
                /**
                 * Returns a listing of names to split costs
                 * @param {object} totals - The totals property from the Order
                 * @returns {string} A view mapping names to split costs
                 */
                _makeTextForClipboard(totals) {
                    if (!this.order) {
                        return;
                    }
                    // get length of longest name
                    var longestName = -1;
                    for (var [person, price] of totals) {
                        longestName = Math.max(person.length, longestName);
                    }

                    // add 1 to longest name for a space after name
                    longestName += 1;

                    var output = '';
                    var name;
                    for (let [person, price] of totals) {
                        let name = person;
                        for (var i = person.length; i < longestName; i++) {
                            name += ' ';
                        }
                        output += name + '$' + this._prettifyNumber(price) + '\n';
                    }

                    return output + '\n' + this._makeUrl(this.order);
                }
                _makeUrl(order) {
                    if (!this.order) {
                        return;
                    }

                    var params = {};
                    params.tax = order.tax;
                    params.fee = order.fee;
                    params.tip = order.tipDollars;

                    var paramString = [...Object.entries(params), ...order.people.entries()].map(([key, value]) => `${key}=${value}`).join('&');

                    return location.href.split('?')[0] + '?' + paramString;
                }
                _handleQueryStringChanged(e, {value}) {
                    this.order = new QueryStringParserLocal().parse();
                }

            });
        })();
    </script>

</dom-module>
